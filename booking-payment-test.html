<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Razorpay Payment Test</title>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg,#667eea,#764ba2);
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      border-radius: 10px;
      padding: 30px;
    }
    h1 { margin-bottom: 30px; text-align: center; color: #333; }
    h2 { margin-bottom: 20px; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
    .section {
      margin-bottom: 30px;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
    }
    label { font-weight: bold; margin-top: 15px; display: block; color: #333; }
    input, select {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    button {
      padding: 12px 20px;
      background: #667eea;
      color: #fff;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      font-weight: bold;
      flex: 1;
      transition: all 0.3s;
    }
    button:hover { background: #5568d3; transform: translateY(-2px); }
    button.secondary { background: #764ba2; }
    button.secondary:hover { background: #633a8a; }
    .status {
      margin-top: 15px;
      padding: 12px;
      display: none;
      border-radius: 5px;
    }
    .success { background: #d4edda; color: #155724; display:block; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; display:block; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; display:block; border: 1px solid #bee5eb; }
    pre {
      background: #fff;
      padding: 15px;
      margin-top: 15px;
      overflow: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      max-height: 300px;
      font-size: 12px;
    }
    .env-info {
      background: #e7f3ff;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
    }
    .env-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #c9e4ff;
    }
    .env-item:last-child { border-bottom: none; }
    .env-key { color: #667eea; font-weight: bold; }
    .env-value { color: #555; font-family: monospace; font-size: 12px; }
  </style>
</head>

<body>

<div class="container">
  <h1>üí≥ Razorpay Payment Test Suite</h1>

  <!-- AUTH SECTION -->
  <div class="section">
    <h2>üîê Step 1: Authentication</h2>

    <label>Email</label>
    <input id="email" value="test@example.com"/>

    <label>Password</label>
    <input id="password" type="password" value="test123"/>

    <label>API URL</label>
    <input id="apiUrl" value="http://localhost:3000"/>

    <label>Razorpay Key ID</label>
    <input id="razorpayKey" placeholder="rzp_test_xxxxx"/>

    <div class="button-group">
      <button onclick="login()">Login</button>
    </div>

    <div id="loginStatus" class="status"></div>
    <pre id="loginRes"></pre>
  </div>

  <!-- PAYMENT SECTION -->
  <div class="section">
    <h2>üí∞ Step 2: Create Payment Order</h2>

    <label>Amount (‚Çπ)</label>
    <input id="amount" value="500" type="number" min="1"/>

    <label>Description</label>
    <input id="description" value="Test Payment"/>

    <div class="button-group">
      <button onclick="createOrder()">Create Order</button>
    </div>

    <div id="paymentStatus" class="status"></div>
    <pre id="paymentRes"></pre>
  </div>

  <!-- RAZORPAY PAYMENT SECTION -->
  <div class="section">
    <h2>üéØ Step 3: Pay with Razorpay</h2>

    <div class="env-info" id="paymentInfo" style="display:none;">
      <strong>Order Details:</strong>
      <div class="env-item">
        <span class="env-key">Order ID:</span>
        <span class="env-value" id="displayOrderId">-</span>
      </div>
      <div class="env-item">
        <span class="env-key">Amount:</span>
        <span class="env-value" id="displayAmount">-</span>
      </div>
    </div>

    <div class="button-group">
      <button class="secondary" onclick="openRazorpay()">Open Razorpay Checkout</button>
    </div>

    <div id="razorpayStatus" class="status"></div>
    <pre id="razorpayRes"></pre>
  </div>

  <!-- VERIFY SECTION -->
  <div class="section">
    <h2>‚úÖ Step 4: Verify Payment</h2>

    <label>Order ID</label>
    <input id="verifyOrder" readonly/>

    <label>Payment ID</label>
    <input id="verifyPayment" readonly/>

    <label>Signature</label>
    <input id="verifySignature" readonly/>

    <div class="button-group">
      <button onclick="verifyPayment()">Verify Payment</button>
    </div>

    <div id="verifyStatus" class="status"></div>
    <pre id="verifyRes"></pre>
  </div>

  <!-- ENVIRONMENT INFO -->
  <div class="section">
    <h2>üìä Session Information</h2>
    <div class="env-info" id="envInfo">
      <div class="env-item">
        <span class="env-key">Status:</span>
        <span class="env-value">Not authenticated</span>
      </div>
    </div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  const env = {
    token: null,
    email: null,
    userId: null,
    razorpayOrderId: null,
    amount: null
  };

  const api = () => document.getElementById('apiUrl').value;

  function show(id, msg, type) {
    const el = document.getElementById(id);
    el.className = 'status ' + type;
    el.innerText = msg;
    el.style.display = 'block';
  }

  function updateEnvInfo() {
    const envInfo = document.getElementById('envInfo');
    if (!env.token) {
      envInfo.innerHTML = '<div class="env-item"><span class="env-key">Status:</span><span class="env-value">Not authenticated</span></div>';
      return;
    }

    let html = '<div class="env-item"><span class="env-key">Status:</span><span class="env-value">‚úÖ Authenticated</span></div>';
    html += '<div class="env-item"><span class="env-key">Email:</span><span class="env-value">' + env.email + '</span></div>';
    html += '<div class="env-item"><span class="env-key">User ID:</span><span class="env-value">' + (env.userId || '-') + '</span></div>';
    if (env.razorpayOrderId) {
      html += '<div class="env-item"><span class="env-key">Current Order:</span><span class="env-value">' + env.razorpayOrderId + '</span></div>';
    }
    envInfo.innerHTML = html;
  }

  async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    if (!email || !password) {
      show('loginStatus', '‚ùå Please enter email and password', 'error');
      return;
    }

    show('loginStatus', '‚è≥ Logging in...', 'info');

    try {
      const res = await fetch(api() + "/api/auth/login", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();

      if (res.ok) {
        env.token = data.token;
        env.email = data.data?.user?.email;
        env.userId = data.data?.user?._id;
        updateEnvInfo();
        show('loginStatus', '‚úÖ Login successful!', 'success');
      } else {
        show('loginStatus', '‚ùå Login failed: ' + (data.message || 'Unknown error'), 'error');
      }

      document.getElementById('loginRes').textContent = JSON.stringify(data, null, 2);
    } catch (error) {
      show('loginStatus', '‚ùå Error: ' + error.message, 'error');
    }
  }

  async function createOrder() {
    if (!env.token) {
      show('paymentStatus', '‚ùå Please login first', 'error');
      return;
    }

    const amount = parseInt(document.getElementById('amount').value);
    const description = document.getElementById('description').value;

    if (!amount || amount < 1) {
      show('paymentStatus', '‚ùå Please enter a valid amount', 'error');
      return;
    }

    show('paymentStatus', '‚è≥ Creating order...', 'info');

    try {
      const res = await fetch(api() + "/api/payments/create-order", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + env.token
        },
        body: JSON.stringify({
          amount: amount,
          description: description,
          receipt: 'rcpt_' + Date.now()
        })
      });

      const data = await res.json();

      if (res.ok) {
        // Extract order ID from nested response structure
        env.razorpayOrderId = data.data?.razorpayOrderId || data.data?.orderId || data.razorpayOrderId || data.orderId || data.order_id || data.id;
        env.amount = amount;
        
        if (!env.razorpayOrderId) {
          show('paymentStatus', '‚ùå Error: Order ID not found in response', 'error');
          document.getElementById('paymentRes').textContent = JSON.stringify(data, null, 2);
          return;
        }
        
        document.getElementById('verifyOrder').value = env.razorpayOrderId;
        document.getElementById('displayOrderId').innerText = env.razorpayOrderId;
        document.getElementById('displayAmount').innerText = '‚Çπ' + amount;
        document.getElementById('paymentInfo').style.display = 'block';
        updateEnvInfo();
        show('paymentStatus', '‚úÖ Order created successfully!', 'success');
      } else {
        show('paymentStatus', '‚ùå Order creation failed: ' + (data.message || 'Unknown error'), 'error');
      }

      document.getElementById('paymentRes').textContent = JSON.stringify(data, null, 2);
    } catch (error) {
      show('paymentStatus', '‚ùå Error: ' + error.message, 'error');
    }
  }

  function openRazorpay() {
    if (!env.razorpayOrderId) {
      show('razorpayStatus', '‚ùå Please create an order first', 'error');
      return;
    }

    if (!document.getElementById('razorpayKey').value) {
      show('razorpayStatus', '‚ùå Please enter your Razorpay Key ID', 'error');
      return;
    }

    show('razorpayStatus', '‚è≥ Opening Razorpay checkout...', 'info');

    const rzp = new Razorpay({
      key: document.getElementById('razorpayKey').value,
      order_id: env.razorpayOrderId,
      name: "Payment Test",
      description: "Test Payment with Razorpay",
      amount: env.amount * 100,
      prefill: {
        email: env.email,
        contact: "9876543210",
        name: "Test User"
      },
      theme: {
        color: "#667eea"
      },
      handler: function(res) {
        document.getElementById('verifyOrder').value = res.razorpay_order_id;
        document.getElementById('verifyPayment').value = res.razorpay_payment_id;
        document.getElementById('verifySignature').value = res.razorpay_signature;
        show('razorpayStatus', '‚úÖ Payment completed! Verify payment details below.', 'success');
        document.getElementById('razorpayRes').textContent = JSON.stringify(res, null, 2);
      },
      modal: {
        ondismiss: function() {
          show('razorpayStatus', '‚ö†Ô∏è Payment cancelled by user', 'error');
        }
      }
    });

    rzp.open();
  }

  async function verifyPayment() {
    if (!env.token) {
      show('verifyStatus', '‚ùå Please login first', 'error');
      return;
    }

    const orderId = document.getElementById('verifyOrder').value;
    const paymentId = document.getElementById('verifyPayment').value;
    const signature = document.getElementById('verifySignature').value;

    if (!orderId || !paymentId || !signature) {
      show('verifyStatus', '‚ùå Please complete payment first', 'error');
      return;
    }

    show('verifyStatus', '‚è≥ Verifying payment...', 'info');

    try {
      const res = await fetch(api() + "/api/payments/verify", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + env.token
        },
        body: JSON.stringify({
          razorpayOrderId: orderId,
          razorpayPaymentId: paymentId,
          razorpaySignature: signature
        })
      });

      const data = await res.json();

      if (res.ok) {
        show('verifyStatus', '‚úÖ Payment verified successfully!', 'success');
      } else {
        show('verifyStatus', '‚ùå Verification failed: ' + (data.message || 'Unknown error'), 'error');
      }

      document.getElementById('verifyRes').textContent = JSON.stringify(data, null, 2);
    } catch (error) {
      show('verifyStatus', '‚ùå Error: ' + error.message, 'error');
    }
  }

  // Initialize and load Razorpay key from backend
  updateEnvInfo();
  
  // Auto-load Razorpay Key from backend
  async function loadRazorpayKey() {
    try {
      const res = await fetch(api() + "/api/config/razorpay-key");
      if (res.ok) {
        const data = await res.json();
        const key = data.key || data.razorpayKey || data.RAZORPAY_KEY_ID;
        if (key) {
          document.getElementById('razorpayKey').value = key;
          console.log('‚úÖ Razorpay Key loaded from backend');
        }
      }
    } catch (error) {
      console.log('‚ÑπÔ∏è Razorpay key endpoint not found - please enter manually');
    }
  }
  
  // Load key on page load
  window.addEventListener('load', loadRazorpayKey);
</script>

</body>
</html>
